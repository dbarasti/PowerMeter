version: '3.8'

services:
  # Backend FastAPI
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: powermeter-backend
    restart: unless-stopped
    environment:
      - MODBUS_PORT=${MODBUS_PORT:-/dev/ttyUSB0}
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - TIMEZONE=${TIMEZONE:-Europe/Rome}
    volumes:
      # Persistenza database SQLite
      - ./data:/app/data:rw
      # Persistenza log
      - ./logs:/app/logs:rw
    devices:
      # Mapping porta seriale Modbus per Windows
      # Su Windows/WSL2, le porte COM vengono mappate come /dev/ttyS*
      # COM1 = /dev/ttyS0, COM2 = /dev/ttyS1, COM3 = /dev/ttyS2, COM4 = /dev/ttyS3
      # Se COM4 non funziona, prova anche /dev/ttyUSB0 o verifica con: docker compose exec backend ls -la /dev/tty*
      - /dev/ttyUSB0:/dev/ttyUSB0:rw
    ports:
      - "8000:8000"
    networks:
      - powermeter-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend SvelteKit
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: powermeter-frontend
    restart: unless-stopped
    environment:
      - BACKEND_URL=http://backend:8000
      - PUBLIC_API_URL=http://localhost:8000
    ports:
      - "5173:5173"
    networks:
      - powermeter-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx reverse proxy (opzionale, per routing unificato)
  nginx:
    image: nginx:alpine
    container_name: powermeter-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - powermeter-network
    depends_on:
      - backend
      - frontend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  powermeter-network:
    driver: bridge
